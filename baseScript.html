<!doctype html>
<html>
<head>
    <title>Dynamic CindyJS Example</title>
    <script src="https://cindyjs.org/dist/latest/Cindy.js"></script>
    <style>
        .content {
            display: flex;
            align-items: flex-start;
        }
        .input-section {
            margin-left: 20px;
            display: flex;
            flex-direction: column;
        }
        #point-input {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="content">
    <div id="cindy-container" style="width: 800px; height: 600px"></div>
    <div class="input-section">
        <!-- Textarea with initial points as editable example -->
        <textarea id="point-input" rows="10" cols="33">
[
    {"name": "A", "pos": [0, 0, 10]},
    {"name": "B", "pos": [10, 0, 10]},
    {"name": "C", "pos": [10, 10, 10]},
    {"name": "D", "pos": [0, 10, 10]},
    {"name": "E", "pos": [5, 5, 10]}
]
        </textarea
        >
        <button onclick="loadPoints()" id="load-points">Load Points</button>
        <button onclick="addPoints()" id="add-points">Add Points</button>
    </div>
</div>
<script>
    let instance = null;

     let initialPoints = [
        { name: "A", pos: [0, 0, 10] },
        { name: "B", pos: [10, 0, 10] },
        { name: "C", pos: [10, 10, 10] },
        { name: "D", pos: [0, 10, 10] },
        { name: "E", pos: [5, 5, 10] },
    ];
    document.getElementById("load-points").addEventListener("click", loadPoints);
    document.getElementById("add-points").addEventListener("click", addPoints);

    function setupCindy(points) {
        let geometry = convertPointsToGeometry(points);

        if (instance) {
            instance.shutdown(); // Shutdown the existing instance before reinitializing
        }

        instance = CindyJS({
            canvasname: "cindy-container",
            geometry: geometry,
        });
    }

    function convertPointsToGeometry(pointsArray) {
        let points = [];
        let joins = [];
        let joinCounter = 1;

        pointsArray.forEach((point) => {
            points.push({
                type: "Free",
                name: point.name,
                pos: point.pos,
            });
        });

        for (let i = 0; i < pointsArray.length; i++) {
            for (let j = i + 1; j < pointsArray.length; j++) {
                let joinName = "j" + joinCounter++;
                joins.push({
                    type: "Join",
                    name: joinName,
                    args: [pointsArray[i].name, pointsArray[j].name],
                });
            }
        }
        return points.concat(joins);
    }
    function loadPoints(){
        {
            const inputValue =
                document.getElementById("point-input").value;
            try {
                const pointsData = JSON.parse(inputValue);
                initialPoints = pointsData;
                setupCindy(pointsData);
            } catch (e) {
                alert("Invalid JSON input");
            }
        }
    }
    function addPoints(){
            const inputValue =
                document.getElementById("point-input").value;
            try {
                const pointsData = JSON.parse(inputValue);
                pointsData.forEach(point =>{
                    initialPoints.push(point);
                })
                setupCindy(pointsData);
            } catch (e) {
                alert("Invalid JSON input");
            }
    }

    // Initialize with example points on page load
    setupCindy(initialPoints);
</script>
</body>
</html>